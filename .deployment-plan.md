# Deployment Guide - Telegram Crossposting SaaS

This guide documents the deployment process for production servers.

## Production Deployment Checklist

### Prerequisites

Before deploying, ensure you have:
- [ ] Server with Docker and Docker Compose installed
- [ ] Domain name (e.g., `telegram-crossposting-saas.aiengineerhelper.com`)
- [ ] DNS A record pointing to your server's IP address
- [ ] Ports 80 (HTTP) and 443 (HTTPS) open on server firewall
- [ ] Valid email address for Let's Encrypt SSL certificates
- [ ] SMTP server configured for email verification
- [ ] All required environment variables ready

### Step 1: Server Setup

SSH into your production server:
```bash
ssh user@your-server-ip
```

Install required packages (if not already installed):
```bash
# Update system
sudo apt update && sudo apt upgrade -y

# Install Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# Install Docker Compose
sudo apt install docker-compose -y

# Add user to docker group
sudo usermod -aG docker $USER
```

### Step 2: Clone Repository

```bash
cd ~
mkdir -p apps
cd apps
git clone https://github.com/YOUR_USERNAME/crossposting-telegram-to-max-saas.git
cd crossposting-telegram-to-max-saas
```

### Step 3: Configure Environment Variables

```bash
cp .env.example .env
nano .env
```

Set these critical variables:
```bash
# Database
POSTGRES_PASSWORD=your_strong_password_here

# JWT
JWT_SECRET_KEY=your_32_character_minimum_secret_key

# SMTP (for email verification)
SMTP_HOST=smtp.example.com
SMTP_PORT=587
SMTP_USER=your-email@example.com
SMTP_PASSWORD=your-smtp-password
SMTP_FROM=your-email@example.com
SMTP_FROM_NAME="Your App Name"

# Cloudflare (captcha)
CLOUDFLARE_TURNSTILE_SECRET=your_turnstile_secret
CLOUDFLARE_TURNSTILE_SITE_KEY=your_turnstile_site_key

# Encryption
ENCRYPTION_KEY=your_32_byte_encryption_key

# URLs
FRONTEND_URL=https://your-domain.com
WEBHOOK_BASE_URL=https://your-domain.com
```

**Important**: Generate strong random values for secrets. Never commit `.env` file.

### Step 4: Update Traefik Configuration

Edit `docker-compose.prod.yml`:
```bash
nano docker-compose.prod.yml
```

Replace `telegram-crossposting-saas.aiengineerhelper.com` with your domain in:
- All `Host(\`domain\`)` labels (6 occurrences total)
- `TRAEFIK_ACME_EMAIL` environment variable

### Step 5: Deploy Application

```bash
docker-compose -f docker-compose.prod.yml up -d --build
```

This will:
- Build frontend (React) and backend (FastAPI) Docker images
- Start all 4 containers (traefik, frontend, backend, postgres)
- Configure Traefik routing
- Configure SSL certificates via Let's Encrypt

**Note**: First deployment may take 5-10 minutes for Let's Encrypt certificate issuance.

### Step 6: Verify Deployment

Check containers are running:
```bash
docker ps --filter "name=crossposter"
```

You should see 4 containers:
- `crossposter-traefik`
- `crossposter-frontend`
- `crossposter-backend`
- `crossposter-postgres`

Test the application:
```bash
# Test frontend
curl -I https://your-domain.com/

# Test health endpoint
curl -I https://your-domain.com/health

# Test API docs
curl -I https://your-domain.com/api/docs

# Check Traefik routers
curl http://your-server-ip:8080/api/http/routers | jq
```

### Step 7: Update DNS

Point your domain to your server:
- Go to your DNS provider (Cloudflare, GoDaddy, etc.)
- Create/update A record: `your-domain.com` → `your-server-ip`
- If using Cloudflare proxy, keep "orange cloud" enabled (proxied)
- Wait for DNS propagation (usually 5-15 minutes)

## Troubleshooting

### Issue: HTTPS returns 404, HTTP works

**Symptom**: `curl http://your-domain.com/` returns 200, but `curl https://your-domain.com/` returns 404

**Cause**: Traefik routers configured for HTTP only

**Fix**:
1. Check Traefik labels use `websecure` entrypoint
2. Verify each router has `tls.certresolver=mytlschallenge` label
3. Check `docker-compose.prod.yml` lines 37-51 (backend) and 91-93 (frontend)

**Example correct labels**:
```yaml
labels:
  - "traefik.http.routers.frontend.entrypoints=websecure"
  - "traefik.http.routers.frontend.tls.certresolver=mytlschallenge"
```

### Issue: Traefik "too many services" error

**Symptom**: `Could not define the service name for the router: too many services`

**Cause**: Multiple service labels defined for same service without explicit reference

**Fix**: Keep only one service definition label, add explicit service reference to routers:

```yaml
# Keep service definition
- "traefik.http.services.backend.loadbalancer.server.port=8000"

# Reference service in each router
- "traefik.http.routers.backend-api.service=backend"
- "traefik.http.routers.backend-auth.service=backend"
```

### Issue: Traefik parsing errors for Host()

**Symptom**: `error while parsing rule Host(domain.com): expected operand, found '/'`

**Cause**: Missing backticks around domain name in Traefik labels

**Fix**: Domain must be wrapped in backticks:
```yaml
# Wrong
"traefik.http.routers.frontend.rule=Host(your-domain.com)"

# Right
"traefik.http.routers.frontend.rule=Host(\`your-domain.com\`)"
```

### Issue: Deployment fails on GitHub Actions (SSH error 255)

**Symptom**: GitHub Actions workflow fails with "Permission denied" or exit code 255

**Cause**: SSH keys not properly configured

**Fix**:

1. Generate SSH key on server:
   ```bash
   ssh-keygen -t ed25519 -C "github-actions" -N "" -f ~/.ssh/github_deploy
   ```

2. Add public key to `authorized_keys`:
   ```bash
   cat ~/.ssh/github_deploy.pub >> ~/.ssh/authorized_keys
   ```

3. Add private key to GitHub Secrets:
   - Go to repo → Settings → Secrets and Variables → Actions
   - Add secret: `SSH_PRIVATE_KEY`
   - Value: Paste content of `~/.ssh/github_deploy` (private key)
   - Add secret: `SERVER_IP`
   - Value: Your server's IP address

4. Add secret: `DEPLOY_USER` (default: root or your username)

### Issue: Let's Encrypt certificate failure

**Symptom**: Traefik logs show ACME/registration errors

**Causes**:
- DNS not pointing to server
- Port 80/443 blocked
- Too many certificate requests in short time (rate limit)

**Fixes**:
1. Verify DNS resolves to correct IP: `nslookup your-domain.com`
2. Check ports open: `nmap -p 80,443 your-domain.com`
3. If rate-limited, use Let's Encrypt staging mode for testing
4. Check Traefik email is valid (for expiration notices)

### Issue: Database connection errors

**Symptom**: Backend logs show "connection refused" or timeout on database

**Fixes**:
1. Wait for postgres to fully start: `docker logs crossposter-postgres`
2. Check docker networks align: `docker network inspect crossposter-network`
3. Verify `DATABASE_URL` uses correct hostname (`postgres`, not `localhost`)
4. Restart backend: `docker restart crossposter-backend`

## Monitoring

### Check Logs

```bash
# All containers
docker-compose -f docker-compose.prod.yml logs -f

# Specific service
docker logs crossposter-traefik
docker logs crossposter-frontend
docker logs crossposter-backend
docker logs crossposter-postgres
```

### Health Checks

```bash
# Application health
curl https://your-domain.com/health

# Container status
docker ps --filter "name=crossposter" --format "table {{.Names}}\t{{.Status}}"

# Disk usage (volumes)
docker system df -v
```

### Traefik Dashboard

Access locally (do not expose publicly):
```bash
# On server
curl http://localhost:8080

# From local machine with SSH tunnel
ssh -L 8080:localhost:8080 user@server
# Then visit http://localhost:8080
```

## Maintenance

### Update Application

```bash
cd ~/apps/crossposting-telegram-to-max-saas
git pull origin main
docker-compose -f docker-compose.prod.yml up -d --build
```

### Backup Database

```bash
# Create backup
docker exec crossposter-postgres pg_dump -U crossposter crossposter > backup_$(date +%Y%m%d).sql

# Restore from backup
docker exec -i crossposter-postgres psql -U crossposter crossposter < backup_20250214.sql
```

### Clear SSL Certificates (for domain change)

```bash
# Stop services
docker-compose -f docker-compose.prod.yml down

# Remove volume
docker volume rm crossposting-telegram-to-max-saas_traefik-letsencrypt

# Restart
docker-compose -f docker-compose.prod.yml up -d
```

## Production Test Checklist

Before accepting traffic, verify:

- [ ] All 4 containers running and healthy
- [ ] HTTPS works correctly (valid SSL padlock in browser)
- [ ] HTTP automatically redirects to HTTPS
- [ ] Frontend loads without errors
- [ ] API docs accessible at `/api/docs`
- [ ] Health endpoint returns 200
- [ ] User registration flow works
- [ ] Email verification emails are received
- [ ] Login/logout works
- [ ] Telegram webhook correctly configured
- [ ] Max API integration works
- [ ] Database persists after container restart
- [ ] No sensitive data in logs

## Rollback Procedure

If deployment causes issues:

```bash
# Quick rollback to previous commit
cd ~/apps/crossposting-telegram-to-max-saas
git log --oneline -5
git checkout <previous_commit_hash>
docker-compose -f docker-compose.prod.yml up -d --build
```

For database rollback, use the backup file created before deployment.

## Reference

- Traefik Docs: https://doc.traefik.io/traefik/
- Let's Encrypt: https://letsencrypt.org/docs/
- FastAPI Deployment: https://fastapi.tiangolo.com/deployment/