name: Deploy Frontend to Monitoring

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy-frontend-monitoring:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: frontend

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Validate Turnstile site key
        run: |
          if [ -z "${{ secrets.CLOUDFLARE_TURNSTILE_SITE_KEY }}" ]; then
            echo "ERROR: CLOUDFLARE_TURNSTILE_SITE_KEY secret is not set"
            exit 1
          fi

      - name: Build frontend
        env:
          VITE_TURNSTILE_SITE_KEY: ${{ secrets.CLOUDFLARE_TURNSTILE_SITE_KEY }}
        run: npm run build

      - name: Upload frontend bundle
        uses: actions/upload-artifact@v4
        with:
          name: crossposter-frontend-dist
          path: |
            frontend/dist
            deploy

      - name: Prepare monitoring server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.MONITORING_SERVER_HOST }}
          username: ${{ secrets.MONITORING_SERVER_USER }}
          key: ${{ secrets.MONITORING_SERVER_SSH_KEY }}
          script_stop: true
          script: |
            set -e
            rm -rf /tmp/crossposter-frontend
            mkdir -p /tmp/crossposter-frontend/dist
            mkdir -p /tmp/crossposter-frontend/deploy

      - name: Copy bundle to monitoring server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.MONITORING_SERVER_HOST }}
          username: ${{ secrets.MONITORING_SERVER_USER }}
          key: ${{ secrets.MONITORING_SERVER_SSH_KEY }}
          source: "frontend/dist/*"
          target: "/tmp/crossposter-frontend/"
          overwrite: true

      - name: Copy deployment config to monitoring server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.MONITORING_SERVER_HOST }}
          username: ${{ secrets.MONITORING_SERVER_USER }}
          key: ${{ secrets.MONITORING_SERVER_SSH_KEY }}
          source: "deploy"
          target: "/tmp/crossposter-frontend/"
          overwrite: true

      - name: Deploy bundle to nginx root
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.MONITORING_SERVER_HOST }}
          username: ${{ secrets.MONITORING_SERVER_USER }}
          key: ${{ secrets.MONITORING_SERVER_SSH_KEY }}
          script_stop: true
          script: |
            set -e

            if [ ! -f /tmp/crossposter-frontend/frontend/dist/index.html ]; then
              echo "ERROR: built frontend index.html not found"
              exit 1
            fi

            if [ ! -f /tmp/crossposter-frontend/deploy/nginx/crossposter-site.conf ]; then
              echo "ERROR: crossposter nginx config not found"
              exit 1
            fi

            sudo -n mkdir -p /var/www/crossposter
            # Keep previous hashed assets to avoid SPA blank-screen after deploy.
            sudo -n rsync -a --delete --exclude 'assets/' /tmp/crossposter-frontend/frontend/dist/ /var/www/crossposter/
            if [ -d /tmp/crossposter-frontend/frontend/dist/assets ]; then
              sudo -n mkdir -p /var/www/crossposter/assets
              sudo -n rsync -a /tmp/crossposter-frontend/frontend/dist/assets/ /var/www/crossposter/assets/
            fi
            sudo -n chown -R www-data:www-data /var/www/crossposter

            sudo -n chmod +x /tmp/crossposter-frontend/deploy/scripts/setup-crossposter-letsencrypt.sh
            sudo -n /tmp/crossposter-frontend/deploy/scripts/setup-crossposter-letsencrypt.sh

            sudo -n cp /tmp/crossposter-frontend/deploy/nginx/crossposter-site.conf /etc/nginx/conf.d/crossposter-site.conf
            sudo -n nginx -t
            sudo -n systemctl reload nginx

            STATUS_CODE="$(curl --silent --insecure --output /dev/null --write-out '%{http_code}' \
              --resolve crossposter.aiengineerhelper.com:443:127.0.0.1 https://crossposter.aiengineerhelper.com/)"
            if [ "${STATUS_CODE}" != "200" ]; then
              echo "ERROR: monitoring frontend HTTPS verification failed (status=${STATUS_CODE}, expected 200)"
              exit 1
            fi

            rm -rf /tmp/crossposter-frontend
            echo "Frontend deployment successful!"
