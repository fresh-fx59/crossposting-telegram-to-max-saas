name: Deploy Frontend to Monitoring

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy-frontend-monitoring:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: frontend

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build

      - name: Upload frontend bundle
        uses: actions/upload-artifact@v4
        with:
          name: crossposter-frontend-dist
          path: frontend/dist

      - name: Prepare monitoring server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.MONITORING_SERVER_HOST }}
          username: ${{ secrets.MONITORING_SERVER_USER }}
          key: ${{ secrets.MONITORING_SERVER_SSH_KEY }}
          script_stop: true
          script: |
            set -e
            rm -rf /tmp/crossposter-frontend
            mkdir -p /tmp/crossposter-frontend/dist

      - name: Copy bundle to monitoring server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.MONITORING_SERVER_HOST }}
          username: ${{ secrets.MONITORING_SERVER_USER }}
          key: ${{ secrets.MONITORING_SERVER_SSH_KEY }}
          source: "frontend/dist/*"
          target: "/tmp/crossposter-frontend/"
          overwrite: true

      - name: Deploy bundle to nginx root
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.MONITORING_SERVER_HOST }}
          username: ${{ secrets.MONITORING_SERVER_USER }}
          key: ${{ secrets.MONITORING_SERVER_SSH_KEY }}
          script_stop: true
          script: |
            set -e

            if [ ! -f /tmp/crossposter-frontend/frontend/dist/index.html ]; then
              echo "ERROR: built frontend index.html not found"
              exit 1
            fi

            sudo -n mkdir -p /var/www/crossposter
            sudo -n find /var/www/crossposter -mindepth 1 -delete
            sudo -n cp -r /tmp/crossposter-frontend/frontend/dist/* /var/www/crossposter/
            sudo -n chown -R www-data:www-data /var/www/crossposter

            STATUS_CODE="$(curl --silent --output /dev/null --write-out '%{http_code}' \
              -H 'Host: crossposter.aiengineerhelper.com' http://127.0.0.1/)"
            if [ "${STATUS_CODE}" != "200" ] && [ "${STATUS_CODE}" != "301" ] && [ "${STATUS_CODE}" != "302" ]; then
              echo "ERROR: monitoring frontend verification failed (status=${STATUS_CODE}, expected 200/301/302)"
              exit 1
            fi

            rm -rf /tmp/crossposter-frontend
            echo "Frontend deployment successful!"
