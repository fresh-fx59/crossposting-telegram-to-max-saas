version: '3.8'

services:
  backend-test:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: crossposter-backend-test
    ports:
      - "8001:8000"
    environment:
      - DATABASE_URL=sqlite+aiosqlite:///./test.db
      - POSTGRES_PASSWORD=test-password
      - JWT_SECRET_KEY=test-jwt-secret-key-for-testing-min-32-chars
      - JWT_ALGORITHM=HS256
      - JWT_ACCESS_TOKEN_EXPIRE_MINUTES=1440
      - SMTP_HOST=
      - SMTP_PORT=587
      - SMTP_USER=
      - SMTP_PASSWORD=
      - SMTP_FROM=test@example.com
      - SMTP_FROM_NAME=Test SMTP
      - EMAIL_VERIFICATION_TOKEN_EXPIRE_HOURS=24
      - PASSWORD_RESET_TOKEN_EXPIRE_HOURS=2
      - CLOUDFLARE_TURNSTILE_SECRET=
      - CLOUDFLARE_TURNSTILE_SITE_KEY=
      - ENCRYPTION_KEY=test-32-byte-encryption-key-for-testing
      - MAX_CONNECTIONS_PER_USER=3
      - MAX_POSTS_PER_DAY_PER_CONNECTION=100
      - POST_HISTORY_RETENTION_DAYS_SUCCESS=30
      - POST_HISTORY_RETENTION_DAYS_FAILED=7
      - FRONTEND_URL=http://localhost:3000
      - WEBHOOK_BASE_URL=http://localhost:8001
      - ENV=test
    volumes:
      - ./backend:/app
      - ./tests:/tests
    command: python -m pytest /tests/test_emulation.py -v -s
    networks:
      - test-network

networks:
  test-network:
    driver: bridge